name: CI

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

env:
  REGISTRY: europe-west4-docker.pkg.dev
  CHART_PATH: europe-west4-docker.pkg.dev/sandbox-9456/helm
  CHART_DIR: chart

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Lint Helm chart
        run: helm lint ${{ env.CHART_DIR }}

      - name: Template Helm chart
        run: helm template test-release ${{ env.CHART_DIR }} --debug

  push:
    runs-on: ubuntu-latest
    needs: [lint]
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.WIF_PROVIDER }}
          service_account: ${{ vars.WIF_SERVICE_ACCOUNT }}
          token_format: access_token

      - name: Log in to Artifact Registry
        run: |
          echo ${{ steps.auth.outputs.access_token }} | helm registry login ${{ env.REGISTRY }} -u oauth2accesstoken --password-stdin

      - name: Get chart version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="0.0.0-dev-sha${GITHUB_SHA::7}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update chart version
        run: |
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.version }}/" ${{ env.CHART_DIR }}/Chart.yaml

      - name: Package Helm chart
        run: helm package ${{ env.CHART_DIR }}

      - name: Push Helm chart
        run: |
          helm push service-chart-${{ steps.version.outputs.version }}.tgz oci://${{ env.CHART_PATH }}
